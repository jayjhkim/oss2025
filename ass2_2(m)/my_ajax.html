<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>22301009 김지홍</title>
</head>
<body>

  <div>
    <button id="btnGet">학생데이터 가져오기</button>
    <div id="contents"></div>
  </div>

  <hr>

  <div>
    <h3>학생데이터 추가</h3>
    <input id="name" placeholder="name">
    <input id="age" placeholder="age">
    <input id="major" placeholder="major">
    <input id="gender" placeholder="gender">
    <button id="btnAdd">학생데이터 추가</button>
  </div>
  
  <hr>

  <div>
    <h3>학생데이터 수정</h3>
    <input id="update_id" placeholder="id">
    <input id="update_name" placeholder="new name">
    <input id="update_age" placeholder="new age">
    <input id="update_major" placeholder="new major">
    <input id="update_gender" placeholder="new gender">
    <button id="btnUpdate">학생데이터 수정</button>
  </div>
  
  <hr>

  <div>
    <h3>학생데이터 삭제</h3>
    <input id="delete_id" placeholder="id">
    <button id="btnDelete">학생데이터 삭제</button>
  </div>

  <script>
    const BASE = "http://localhost:3001/students";
    let studentsData = [];

    document.getElementById("btnGet").addEventListener("click", getStudents);

    function getStudents() {
      let xhr = new XMLHttpRequest();
      xhr.open("GET", BASE);

      xhr.onload = function () {
        if (xhr.status === 200) {
          const res = JSON.parse(xhr.responseText);
          studentsData = res.map(s => ({
            id: String(s.id),
            name: s.name,
            age: s.age,
            major: s.major,
            gender: s.gender
          }));
          document.getElementById("contents").innerHTML = makeList(studentsData);
        }
      };
      xhr.send();
    }

    function makeList(data) {
      let str = "<ul>";
      for (let s of data) {
        str += `<li>${s.id}. ${s.name} (age: ${s.age}, major: ${s.major}, gender: ${s.gender})</li>`;
      }
      str += "</ul>";
      return str;
    }

    document.getElementById("btnAdd").addEventListener("click", postData);

    function postData() {
      let name = document.getElementById("name").value.trim();
      let age = Number(document.getElementById("age").value);
      let major = document.getElementById("major").value.trim();
      let gender = document.getElementById("gender").value.trim();

      if (!name || Number.isNaN(age) || !major || !gender) {
        alert("모든 항목을 입력하세요!");
        return;
      }

      let maxId = studentsData.length > 0
        ? Math.max(...studentsData.map(s => Number(s.id)))
        : 0;

      let nextId = String(maxId + 1);

      let data = { id: nextId, name, age, major, gender };

      let xhr = new XMLHttpRequest();
      xhr.open("POST", BASE);
      xhr.setRequestHeader("Content-Type", "application/json; charset=UTF-8");

      xhr.onload = function () {
        getStudents();
        document.getElementById("name").value = "";
        document.getElementById("age").value = "";
        document.getElementById("major").value = "";
        document.getElementById("gender").value = "";
      };

      xhr.send(JSON.stringify(data));
    }

    document.getElementById("btnUpdate").addEventListener("click", updateData);

    function updateData() {
      let id = document.getElementById("update_id").value.trim();

      if (!id) {
        alert("ID를 입력하세요!");
        return;
      }

      let name = document.getElementById("update_name").value.trim();
      let ageStr = document.getElementById("update_age").value;
      let age = ageStr ? Number(ageStr) : null;
      let major = document.getElementById("update_major").value.trim();
      let gender = document.getElementById("update_gender").value.trim();

      let data = {};
      if (name) data.name = name;
      if (ageStr && !Number.isNaN(age)) data.age = age;
      if (major) data.major = major;
      if (gender) data.gender = gender;

      if (Object.keys(data).length === 0) {
        alert("수정할 값을 입력하세요!");
        return;
      }

      let xhr = new XMLHttpRequest();
      xhr.open("PUT", `${BASE}/${id}`);
      xhr.setRequestHeader("Content-Type", "application/json; charset=UTF-8");

      xhr.onload = function () {
        getStudents();
      };

      xhr.send(JSON.stringify(data));
    }

    document.getElementById("btnDelete").addEventListener("click", deleteData);

    function deleteData() {
      let id = document.getElementById("delete_id").value.trim();

      if (!id) {
        alert("ID를 입력하세요!");
        return;
      }

      let xhr = new XMLHttpRequest();
      xhr.open("DELETE", `${BASE}/${id}`);

      xhr.onload = function () {
        getStudents();
      };

      xhr.send();
    }
  </script>

</body>
</html>
